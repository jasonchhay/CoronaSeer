{% extends "seer/base.html" %}
{% load static %}

{% block css %}
	<link rel="stylesheet" href="{% static 'css/results.css' %}">
{% endblock %}

{% block content %}
	<div class="container" id="app">
		<!--<p v-cloak>[[message]]</p>-->
		<div class="results-container" >
			<div id="search-container" >
				<a href="{% url 'home' %}">
					<img src="{% static 'img/covidseer_logo.png' %}" alt="COVIDSeer Logo"  height="80"/>
				</a>
				<form method="GET" action="{% url 'search' %}">
			        <div class="search-bar-wrapper">
				            <input type="text" name="query" id="search-box" class='form-control' value="{{ q }}"/>
				            <!-- <input type="hidden" name="type" id="q_type" value="Figures"/> -->
					        <button type="submit" value="search" class="search-button btn">
						        <i class="fas fa-search"></i>
					        </button>
			        </div>
		        <br/>
		        </form>
			</div>
			<div class="row">
				<div class="col-md-8">
					<div class="result-list">
						{% if errormessage %}
					    <div id="navwrapper" style="margin-bottom: 20vh; font-weight: 800;">
					        {{ errormessage }}
					    </div>
				        {% else %}
						<div id="result-info">
							Results <strong>{{position}} - {{nextResults}} </strong> of <strong>{{total}}</strong>
						</div>
						
						<div class="result" v-for="hit in results" :key="hit.resultid" v-cloak>
							<div class="url" >
								<h5 class="result-title"><b><a href="google.com">[[hit.title]]</a></b></h5>
								<!--<p>{{ hit.c }} </p></div>-->
								<div class="author-container">
									{% for author in hit.authors %}
										<div class="author">
											<p>{{author.name}}</p>
											<div class="author-content">
												<h4>{{ author.name }}</h4>
												<table>
													<tr>
														<th>Location:</th>
														<td>{{ author.location }}</td>
													</tr>
													<tr>
														<th>Institution:</th>
														<td>{{ author.institution }}</td>
													</tr>
													<tr>
														<th>Laboratory:</th>
														<td>{{ author.laboratory }}</td>
													</tr>
												</table>
											</div>
										</div>{% if forloop.counter < hit.authors|length %}, {% endif %}
									{% endfor %}
									</div>
									<span class="description row">
										<div class="col-md-12">
											<p>[[hit.description]]</p>
										</div>
									</span>
									<div class="journal row">
										<div class="col-md-12"><b>Journal:</b>[[hit.journal]]</div>
									</div>
									<div class="source row">
										<div class="col-md-6">
											<b>Source:</b> [[hit.source]]
										</div>
										<div class="col-md-6 doi-link">
											<a href="https://doi.org/[[hit.doi]]" target="_blank" class="doi-link">View full article</a>
										</div>
									</div>
								</div>
								<div class="location" ><p>[[hit.affiliation]]</p></div>
							</div>
						</div>
						
						<div class="pager">
							<span id="prev-page">
								{% if prevResults != prevPageLimit and prevPage > 0 %}
								<a href="{% url 'search' %}?query={{q}}&page={{ prevPage }}">Prev</a>
								{% else %}
								Prev
								{% endif %}
							</span>
							
							{% for i in prevPageList %}
								<a href="{% url 'search' %}?query={{q}}&page={{ i }}">{{ i }}</a>
							{% endfor %}
							<strong>{{ page }}</strong>
							{% for i in nextPageList %}
								<a href="{% url 'search' %}?query={{q}}&page={{ i }}">{{ i }}</a>
							{% endfor %}
							
							<span id="next-page">
								{% if nextResults != nextPageLimit and nextPage <= nextPageLimit %}
								<a href="{% url 'search' %}?query={{q}}&page={{ nextPage }}">Next</a>
								{% else %}
								Next
								{% endif %}
							</span>
						</div>
					{% endif %}
					</div>
					<div class="filter-box col-md-4">
						<div class="card">
							<h5 class="card-header">
								Filter results
							</h5>
							<!--[[appliedFilters]]-->
							<div class="card-body">
								<form id="filter-form" method="GET" action="{% url 'search' %}">
									<div v-for="(filter, key) in resultFilters" :key="key">
										<a class="collapsed" data-toggle="collapse" :href="'#' + key" aria-expanded="false" :aria-controls="key">
											<h5>
												[[filter.displayName]] ([[filter.total]])	<i class="fas fa-angle-down rotate-icon"></i>
											</h5>
										</a>
										<div :id="key" class="collapse" role="tabpanel">
											<div v-for="(option, index) in filter.options" key="index" class="ui checked checkbox">
												<label>
													<input class="source-checkbox" type="checkbox" :value="option.name"
													urls="{% url 'search' %}" v-model="appliedFilters[key]" v-on:click="filterResults">
													[[option.name]]  ([[option.count]])
												</label>
											</div>
										</div>
									</div>							
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block vuejs %}
<script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js'></script>
<script type='text/javascript'>
      new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        // define data - initial display text
        data: {
          query: $('#search-box').val(),
		  results: [],
		  resultFilters: [],
		  appliedFilters: {},
		  page: 1
        },
		beforeMount() {
			console.log(this.query);
			this.getResults(this.query, 1);
		},
		methods: {
			getResults: function(query) {
				axios
				.get(`/api/search/${query}/1`)
				.then(response => {
					const data = response.data.context;
					
					this.query = data.query;
					this.results = data.results;
					this.resultFilters = data.filters;

					for(const [key, value] of Object.entries(this.resultFilters)) {
						this.appliedFilters[key] = [];
					}
				})
			}, 

			filterResults: function() {
				var filter_query = '';
				for (let [key, filterList] of Object.entries(this.appliedFilters)) {
					console.log(key + " " + filterList);
					filter_query = filter_query.concat(`${key}=${filterList}&`)
				}
				console.log(filter_query);

				axios
				.get(`/api/search/${this.query}/1?${filter_query}`)
				.then(response => {
					this.results = response.data.context.results;
				})
			}, 
		}
      })
</script>
{% endblock %}

{% block javascript %}
<!--
<script>
	$(document).ready(function(){
		if(!sessionStorage.activeCollapses) {
			sessionStorage.activeCollapses = []
		}

		$('a[data-toggle="collapse"]').on('show.bs.collapse', function(e) {
			sessionStorage.activeCollapses.push(this)
		});

		$('a[data-toggle="collapse"]').on('hide.bs.collapse', function(e) {
			sessionStorage.activeCollapses.push(this)
		});


		var activeCollapses = sessionStorage.getItem('activeCollapses');

		if(activeCollapses){
			for(const header in activeCollapses) {
				$(header).collapse('show');
			}
		}
	});

	form = document.getElementById('filter-form');

	if(form.addEventListener) {
    	form.addEventListener("submit", submitFn, false);
	} else {
    	form.attachEvent("onsubmit", submitFn); //IE8
	}

	function submitFn(event) {
		event.preventDefault();

		var checkboxes = [];
		$('input:checked').each(function() {
			checkboxes.push($(this));
			$(this).val("checked", false);
		});

		checked = {}
		
		for(i = 0; i < checkboxes.length; i++) {
			var box = checkboxes[i];
			key = box.attr('name');
			!(key in checked) && (checked[key] = [])

			checked[key].push(box.attr('value'));
		}
		
		for([key, value] of Object.entries(checked)) {
			var checkedStr = value.join();

			var input = $("<input>", {type: "hidden", name: key, value: checkedStr});
			
			console.log("INPUT:  " + input.name);
			$(form).append(input);
		}
		
		form.submit();
		return false;
	}

</script>
-->
{% endblock %}